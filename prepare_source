pkg=linux
version_orig=6.12.9
version="$version_orig-1"

(
	kernel_repo=https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
	debian_repo=https://salsa.debian.org/kernel-team/linux.git
	debian_ref="debian/6.12.9-1"

	tmp_dir="$(mktemp -d)"
	trap 'cd / && rm -rf "$tmp_dir"' EXIT
	cd "$tmp_dir"

	git clone --depth 1 --branch "$debian_ref" "$debian_repo" linux
	cd linux

	apt-get install --no-install-recommends -y devscripts sopv-gpgv strace # needed for uscan
	ln -s /usr/bin/sopv-gpgv /usr/bin/sopv
	strace -f -Z uscan -vvv --download-version="$version_orig"

	git clean -fdx

	auto_decompress ../*.orig.tar.* | tee "$dir/orig.tar" | tar --extract --strip-components 1 --directory "$dir/src"
	cp -r debian "$dir/src/"
)

rm -rf "$dir/src/debian/config"
cp -r config "$dir/src/debian/"

apply_patches fixes_debian
import_upstream_patches
